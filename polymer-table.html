<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../elements/polymer-table/polymer-table-row.html">
<dom-module id="polymer-table">
  <template>
    <style>
      :host {
        display: block;
      }

      .pageCounter {
        background-color:transparent;
        width:24px;
        border:none;
        text-align:right;
        font-size:13px;
        vertical-align: middle;
        line-height:24px;
        font-weight:600;
      }

      .headerText {
        padding-left:4px;
      }
      .noselect {
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none;   /* Chrome/Safari/Opera */
        -khtml-user-select: none;    /* Konqueror */
        -moz-user-select: none;      /* Firefox */
        -ms-user-select: none;       /* Internet Explorer/Edge */
        user-select: none;           /* Non-prefixed version, currently
                                        not supported by any browser */
      }
      .table {
        border:1px solid #CCCCCC;
        border-radius:2px;
                margin-bottom:8px;
      }
      .footer {
        @apply(--layout-horizontal);
        margin-bottom:8px;
      }
      .header {
        letter-spacing: 1px;
        @apply(--layout-horizontal);
        background-color:#DADADA;
        font-size:13px;
        line-height: 24px;
        font-weight:400;}
      .header > div {
        @apply(--layout-flex);
        }
      .tablebody {
        font-weight:300;
        font-size:13px;}
      .tablebody > .row:nth-child(even) {
        background-color:#EEEEEE;}

      .cellHeader {
        @apply(--layout-horizontal);
        apply(--layout-center);
      }
      .cellHeaderRow {

        max-width: 58px;
        min-width: 58px;
        @apply(--layout-horizontal);
        apply(--layout-center);
      }
      .space {
        @apply(--layout-flex);
      }

      .cellHeader > div > iron-icon {
        opacity:0.2;
        cursor:pointer;
      }
      .cellHeader > div > iron-icon:hover {
        opacity:1;
      }
      .cellHeader > div > iron-icon[sorting] {
        opacity:1;
      }

      .headerActions {

      }
      .infos {
        @apply(--layout-horizontal);
        font-size:13px;
        line-height:24px;
        color:grey;
      }

      .infos > div {
        margin-left:4px;
        margin-right:4px;
      }

      .infos > .number {
        color:black;
      }

      .iconSpace {
        width:24px;
      }
      .rowIndex {
        max-width:48px!important;
        min-width:48px!important;
            text-align: center;
          }

          .headerTextRow {
            text-align: center;
            width:100%;
          }
          .cellHeader {cursor:pointer;}

          .pageSelection {
            cursor:pointer;
            background-color:transparent;
            width:24px;
            border:none;
            text-align:right;
            font-size:13px;
            vertical-align: middle;
            line-height:24px;
            font-weight:600;
          }
          .pageSelection[selected] {color:green}
          .pageSelection:hover {color:green}
    </style>

<div class="table noselect">
  <div class="header">
    <template is="dom-if" if="[[showRowIndex]]">
    <div class="cellHeaderRow" >
       <div class="headerTextRow">#</div>
    </div>
    </template>
    <template is="dom-repeat" items="[[columns]]">
      <div class="cellHeader" column$="[[index]]" on-tap="columnSelection">
         <div class="headerText">[[item]]</div>
         <div class="space"></div>
         <div><iron-icon icon="expand-more" column$="[[item]]" on-tap="sortUp"></iron-icon></div>
         <div><iron-icon icon="expand-less" column$="[[item]]" on-tap="sortDown"></iron-icon></div>
       </div>

        </template>
        <template is="dom-if" restamp="true" if="[[showActions]]">
        <div style="[[computeWidth(userActions.length)]]">
        </div>
      </template>
     </div>
     <div class="tablebody">
        <template is="dom-repeat" delay="50" sort="{{sortData(sortString,sortOrder)}}" items="[[paginatedData]]" as="rowData">
            <polymer-table-row on-cell-selection-clear="clearSelections" index="[[getIndex(index,currentPage,pageLength)]]" show-row-index="[[showRowIndex]]" show-actions="[[showActions]]" data="[[rowData]]" actions="[[userActions]]" on-action-tap="doRowAction" on-select="selectRow" columns="[[columns]]"></polymer-table-row>
        </template>
      </div>
      </div>
      <template is="dom-if" if="[[showFooter]]" restamp=true>
       <div class="footer noselect">
        <iron-icon icon="chevron-left" on-tap="pageDown"></iron-icon>
          <div class="pageCounter">[[currentPage]]</div>
          <iron-icon icon="chevron-right" on-tap="pageUp"></iron-icon>
          <div class="infos">
            <div>Showing from</div><div class="number">[[firstShowing(currentPage,pageLength)]]</div><div>to</div><div class="number">[[lastShowing(currentPage,pageLength,paginatedData)]]</div>
          </div>
        <div class="space"></div>
        <div class="pageSelection" selected on-tap="updatePageLength" value="10">10</div>
        <div class="pageSelection" on-tap="updatePageLength" value="25">25</div>
      </div>
    </template>
</template>
  <script>
  (function() {
    'use strict';

    Polymer({
      getIndex:function(index,currentPage,pageLength) {
        return (+index+1)+(pageLength*(currentPage-1))
      },
      updatePageLength:function(e) {
        this.toggleAttribute("selected",false,this.$$(".pageSelection[selected]"));
        this.toggleAttribute("selected",true,e.target);
        this.set("pageLength",+e.target.getAttribute("value"));
        this.set("currentPage",1)
      },
      firstShowing:function(currentPage,pageLength) {
        return 1+(currentPage-1)*pageLength
      },
      lastShowing:function(currentPage,pageLength) {
        if (this.paginatedData && pageLength>this.paginatedData.length) return this.paginatedData.length
        return (currentPage)*pageLength
      },
      deleteRow:function(e) {
        this.arrayDelete("data",e.model.rowData);
        this.notifyPath("data",this.data.slice());
      },
      doRowAction:function(e) {
          this[e.detail.action.callback](e);
      },
      clearSelections:function(e) {
        Array.from(this.querySelectorAll("polymer-table-row")).map(x=>{
          x.clearSelection();
        })
      },
      columnSelection:function(e) {
        if (this.columnSelectable) Array.from(this.querySelectorAll("polymer-table-row")).map(x=>{
          x.selectColumn(e.currentTarget.getAttribute("column"),(this.pageLength>=this.paginatedData.length) ? this.paginatedData.length : this.pageLength);
        })
      },
      computeWidth:function(e) {
        return "max-width:"+(24*e)+"px!important"
      },
      is: 'polymer-table',
      sortUp:function(s) {
          s.stopPropagation();
          this.set("sortOrder",1);
          this.set("sortString",s.target.getAttribute("column"));
          this.toggleAttribute("sorting",false,this.$$("iron-icon[sorting]"));
          this.toggleAttribute("sorting",true,s.target);

      },
      sortDown:function(s) {
          s.stopPropagation();
          this.set("sortOrder",-1);
          this.set("sortString",s.target.getAttribute("column"));
          this.toggleAttribute("sorting",false,this.$$("iron-icon[sorting]"));
          this.toggleAttribute("sorting",true,s.target);
      },

      sortData:function(s) {
        if (s) {
          return function(a,b) {
            return (this.sortOrder*(+a[this.sortString]-b[this.sortString]))
          }.bind(this)
        } else {return null}
      },
      pageUp:function() {
          if ((this.currentPage+1)<this.getMaxPage()) {this.currentPage++;}
      },
      pageDown:function() {
          if (this.currentPage>1) {this.currentPage--;}
      },
      getMaxPage:function () {
        if (this.data) {return 1+Math.round(this.data.length/this.pageLength);}
        return 0
      },
      //deprecated
      updatePage:function(e) {
        this.currentPage=e.target.value;
      },

      selectRow:function(e) {
        var n = this.querySelector("polymer-table-row[selected]");
        if (n) {n.selected=false;}
        e.target.selected=true;
        this.currentSelectedItem=e.model.item;
      },

      getColumnsNames:function(datum) {
          if (datum) {
          return Object.keys(datum);
        }
      },

      disableSelection:function() {
          var n=this.querySelector("polymer-table-row[selected]")
          if (n) n.selected=false;
      },

      ready:function() {
        var socket = io.connect('https://localhost:3000');
          socket.on('news', function (data) {
            this.set("data",data);
          }.bind(this));
        document.addEventListener("click",function(e) {
          if (!Polymer.dom(e).rootTarget.classList.contains("polymer-table-row") && !Polymer.dom(e).rootTarget.classList.contains("polymer-table")) {
            this.disableSelection();
            this.currentSelectedItem=undefined
          }
        }.bind(this));

      },

      paginateData:function(data,page,pageLength,pagination) {
          var paginatedData=[];
          if (pagination) {
              //console.time("pagination");
              var index = (page-1)*pageLength;
              for (var o=index;o<(page)*pageLength;o++) {
                  if (o<data.length){
                  paginatedData.push(data[o])}
              }
              //console.timeEnd("pagination");
              return paginatedData
          }
          return data
      },
      exportData:function() {
        console.log(this.paginateData(this.data,this.currentPage,this.pageLength,this.pagination))
      },
      properties: {
        showActions:{
          value:true,
        },
        showRowIndex:{
          value:true
        },
        userActions:{value:[
          {value:"delete",callback:"deleteRow",icon:"delete"}
        ]},
        showFooter:{value:true},
        paginatedData:{computed:"paginateData(data,currentPage,pageLength,pagination)"},
        columnSelectable:{value:true},
        currentPage:{value:1},
        pagination:{value:true},
        pageLength:{value:50},
        columns:{computed:"getColumnsNames(data.0)"},
        currentSelectedItem:{},
        data:{value:[],type:Array}
      }
    });
  })();
  </script>
</dom-module>
